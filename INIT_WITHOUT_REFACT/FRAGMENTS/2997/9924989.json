{"BEFORE":"        q = q * self.scale\n\n        sim = einsum('b h d i, b h d j -> b h i j', q, k)\n        sim = sim - sim.amax(dim = -1, keepdim = True).detach()\n","AFTER":"        q, k = map(l2norm, (q, k))\n\n        sim = einsum('b h d i, b h d j -> b h i j', q, k) * self.scale\n"}