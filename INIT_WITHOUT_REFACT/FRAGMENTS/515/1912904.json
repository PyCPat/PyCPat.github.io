{"BEFORE":"        bh, *_, h, buckets, dim, dim_sort = *q.shape, self.heads, self.buckets, self.dim, self.dim_sort\n        b = bh \/\/ h\n\n        Wsq, Wsk, pos_q, pos_k = map(partial(expand_batch_and_merge_head, b), (self.linear_sort_q, self.linear_sort_k, self.q_pos_emb, self.k_pos_emb))\n\n        k_r = torch.cat((cumavg(k, dim=1), k), dim=-1)\n        k_r = bucket(buckets, k_r)\n\n        b_q_r = b_k_r = k_r[:, :, 0]\n\n        b_qi = torch.cat((b_q_r, pos_q), dim=-1)\n        b_ki = torch.cat((b_k_r, pos_k), dim=-1)\n\n        sq = b_qi @ Wsq\n        sk = b_ki @ Wsk\n","AFTER":"        q_r = bucket(buckets, cumavg(q, dim=1))\n        k_r = bucket(buckets, cumavg(k, dim=1))\n\n        b_q_r = q_r[:, :, 0]\n        b_k_r = k_r.sum(dim=2)\n\n        sq = b_q_r + pos_q\n        sk = b_k_r + pos_k\n"}