{"BEFORE":"        b, _, h, w = q.shape\n","AFTER":"    def forward(self, x, context = None):\n        b, c, h, w, k_dim = *x.shape, self.key_dim\n\n        q, k, v = (self.to_q(x), self.to_k(x), self.to_v(x))\n\n        q = q.reshape(b, self.heads, -1, h * w)\n        k = k.reshape(b, -1, h * w)\n        v = v.reshape(b, -1, h * w)\n\n        if context is not None:\n            context = context.reshape(b, c, 1, -1)\n            ck = self.to_k(context).reshape(b, k_dim, -1)\n            cv = self.to_v(context).reshape(b, k_dim, -1)\n            k = torch.cat((k, ck), dim=2)\n            v = torch.cat((v, cv), dim=2)\n\n        k = k.softmax(dim=2)\n"}