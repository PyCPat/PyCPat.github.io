{"BEFORE":"        x = x.contiguous().view(b, h * w, c).repeat(1, 1, self.heads)\r\n        x = x.contiguous().view(b, self.heads, h * w, c)\r\n        k, v = x, x\r\n        # b m d -> b m h*c -> b h m c\r\n        q = self.to_q(z).view(b, self.heads, m, c)\r\n        dots = einsum('b h m c, b h l c -> b h m l', q, k) * self.scale\r\n        # b h m l\r\n        attn = self.attend(dots)\r\n        out = einsum('b h m l, b h l c -> b h m c', attn, v)\r\n","AFTER":"        x = x.contiguous().view(b, h * w, c).unsqueeze(1)\r\n        q = self.to_q(z).view(b, self.heads, m, c)\r\n        dots = q @ x.transpose(2, 3) * self.scale\r\n        attn = self.attend(dots)\r\n        out = attn @ x\r\n"}