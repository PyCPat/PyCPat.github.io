{"BEFORE":"        return x\n","AFTER":"        b, n, d, e = *inputs.shape, self.num_experts\n        dispatch_tensor, combine_tensor, loss = self.gate(inputs)\n        expert_inputs = torch.einsum('bnd,bnec->ebcd', inputs, dispatch_tensor)\n\n        orig_shape = expert_inputs.shape\n        expert_inputs = expert_inputs.reshape(e, -1, d)\n        expert_outputs = self.experts(expert_inputs)\n        expert_outputs = expert_outputs.reshape(*orig_shape)\n\n        output = torch.einsum('ebcd,bnec->bnd', expert_outputs, combine_tensor)\n        return output, loss * self.loss_coef\n"}