{"BEFORE":"        b = bh \/\/ self.heads\n\n        b_q = bucket(buckets, q) if self.n_sortcut == 0 else bucket(1, q)\n        b_k = bucket(buckets, k)\n\n        Wsq = expand_dim(self.linear_sort_q, 0, b).reshape(bh, dim, dim_sort)\n        Wsk = expand_dim(self.linear_sort_k, 0, b).reshape(bh, dim, dim_sort)        \n\n        b_qi, b_ki = b_q.mean(dim=2), b_k.mean(dim=2)\n","AFTER":"        b = bh \/\/ self.heads\n\n        b_q = bucket(buckets, q) if self.n_sortcut == 0 else bucket(1, q)\n        b_k = bucket(buckets, k)\n\n        Wsq, Wsk, pos_q, pos_k = map(partial(expand_batch_and_merge_head, b), (self.linear_sort_q, self.linear_sort_k, self.q_pos_emb, self.k_pos_emb))\n\n        b_qi = torch.cat((b_q.mean(dim=2), pos_q), dim=-1)\n        b_ki = torch.cat((b_k.mean(dim=2), pos_k), dim=-1)\n"}