{"BEFORE":"        with autocast(enabled = self.amp):\n            loss = self.decoder(x, unet_number = unet_number, **kwargs)\n            scaled_loss = self.scale(loss \/ divisor, unet_number = unet_number)\n            scaled_loss.backward()\n        return loss.item()\n","AFTER":"        batch_size = x.shape[0]\n        total_samples = 0\n        total_loss = 0.\n\n        for chunk_size, (chunked_args, chunked_kwargs) in split_args_and_kwargs(x, split_size = max_batch_size, **kwargs):\n            with autocast(enabled = self.amp):\n                loss = self.decoder(*chunked_args, unet_number = unet_number, **chunked_kwargs)\n\n                total_loss += loss.item() * chunk_size\n                total_samples += chunk_size\n\n                self.scale(loss * (chunk_size \/ batch_size), unet_number = unet_number).backward()\n\n        return total_loss \/ total_samples\n"}