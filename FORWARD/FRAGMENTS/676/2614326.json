{"BEFORE":"        merge_heads = lambda x: x.reshape(b, -1, h, dh).transpose(1, 2)\n\n        q = merge_heads(q)\n\n        if not self.one_kv_head:\n            k, v = map(merge_heads, (k, v))\n\n        out = []\n\n        split_index_fn = partial(split_at_index, 1, self.local_attn_heads)\n\n        if not self.one_kv_head:\n            (lq, q), (lk, k), (lv, v) = map(split_index_fn, (q, k, v))\n        else:\n            lq, q = split_index_fn(q)\n            lk = expand_dim(k, 1, self.local_attn_heads)\n            lv = expand_dim(v, 1, self.local_attn_heads)\n","AFTER":"        merge_heads = lambda x: x.reshape(*x.shape[:2], -1, dh).transpose(1, 2)\n\n        q, k, v = map(merge_heads, (q, k, v))\n\n        out = []\n\n        split_index_fn = partial(split_at_index, 1, self.local_attn_heads)\n\n        if not self.one_kv_head:\n            (lq, q), (lk, k), (lv, v) = map(split_index_fn, (q, k, v))\n        else:\n            lq, q = split_index_fn(q)\n\n            split_kv_fn = partial(split_at_index, 1, int(self.local_attn_heads > 0))\n            (lk, k), (lv, v) = map(split_kv_fn, (k, v))\n\n            local_expand_heads_fn = lambda t: expand_dim(t, 1, self.local_attn_heads, unsqueeze=False)\n            lk, lv = map(local_expand_heads_fn, (lk, lv))\n\n            k, v = map(lambda t: t.squeeze(1), (k, v))\n"}