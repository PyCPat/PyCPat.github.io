{"BEFORE":"            dots.masked_fill_(~mask, float('-inf'))\n","AFTER":"        dots = torch.einsum('bhid,bhjd->bhij', q, k) * self.scale\n        mask_value = -torch.finfo(dots.dtype).max\n\n        if mask is not None:\n            mask = F.pad(mask.flatten(1), (1, 0), value = True)\n            assert mask.shape[-1] == dots.shape[-1], 'mask has incorrect dimensions'\n            mask = mask[:, None, :] * mask[:, :, None]\n            dots.masked_fill_(~mask, mask_value)\n"}